<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Voting Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    #totalVotes,
    #winnerDisplay {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    #totalVotes {
      color: #ff4d4d;
    }

    #winnerDisplay {
      color: #FFD700;
      /* Gold for the winner */
    }
  </style>
</head>

<body>
  <h2 class="page-title">Live Voting Results</h2>
  <div id="totalVotes">Total Votes Cast: 0</div>
  <div id="winnerDisplay">üèÜ Current Winner: None</div>
  <div style="width: 600px; margin: auto;">
    <canvas id="barChart"></canvas>
    <br>
    <canvas id="pieChart"></canvas>
  </div>

  <script>
    let barChart, pieChart;

    async function fetchResults() {
      const response = await fetch("/api/results");
      let data = await response.json();

      if (!data.length) {
        document.getElementById("winnerDisplay").innerText = "üèÜ Current Winner: None";
        return;
      }

      // Sort by votes (descending)
      data.sort((a, b) => b[1] - a[1]);

      const candidates = data.map(item => item[0]);
      const votes = data.map(item => item[1]);

      // Update total votes
      const total = votes.reduce((a, b) => a + b, 0);
      document.getElementById("totalVotes").innerText = "Total Votes Cast: " + total;

      // Highlight winner with gold
      const colors = votes.map((v, i) => (i === 0 ? "#FFD700" : "#4da6ff"));

      // Show winner info
      const winnerName = candidates[0];
      const winnerVotes = votes[0];
      document.getElementById("winnerDisplay").innerText =
        "üèÜ Current Winner: " + winnerName + " (" + winnerVotes + " votes)";

      if (barChart && pieChart) {
        // Update existing charts
        barChart.data.labels = candidates;
        barChart.data.datasets[0].data = votes;
        barChart.data.datasets[0].backgroundColor = colors;
        barChart.update();

        pieChart.data.labels = candidates;
        pieChart.data.datasets[0].data = votes;
        pieChart.data.datasets[0].backgroundColor = colors;
        pieChart.update();
      } else {
        // Bar Chart
        barChart = new Chart(document.getElementById("barChart"), {
          type: "bar",
          data: {
            labels: candidates,
            datasets: [{
              label: "Votes",
              data: votes,
              backgroundColor: colors
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            }
          }
        });

        // Pie Chart
        pieChart = new Chart(document.getElementById("pieChart"), {
          type: "pie",
          data: {
            labels: candidates,
            datasets: [{
              data: votes,
              backgroundColor: colors
            }]
          }
        });
      }
    }

    // Initial fetch
    fetchResults();
    // Auto-refresh every 5 seconds
    setInterval(fetchResults, 5000);
  </script>
</body>

</html>